name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify version consistency
        run: |
          PLUGIN_VERSION=$(grep -oP "Version:\s*\K[0-9.]+" zbooks-for-woocommerce.php)
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "Version mismatch: plugin ($PLUGIN_VERSION) != tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version verified: $PLUGIN_VERSION"

      - name: Install Composer dependencies (production)
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Create plugin zip
        run: |
          mkdir -p dist/zbooks-for-woocommerce
          # Copy files to subfolder (excluding dev files)
          # WordPress.org requirements:
          # - No .sh files (shell scripts not permitted)
          # - Must include composer.json if vendor/ exists
          # - Must include readme.txt
          # - No dev dependencies in vendor/
          rsync -av --exclude='.git' --exclude='.github' --exclude='.wordpress-org' \
            --exclude='node_modules' --exclude='tests' --exclude='playwright' \
            --exclude='playwright-report' --exclude='test-results' --exclude='.wp-env*' \
            --exclude='phpcs.xml*' --exclude='phpunit.xml*' --exclude='composer.lock' \
            --exclude='package-lock.json' --exclude='package.json' --exclude='dist' \
            --exclude='bin' --exclude='.claude' --exclude='.cursorignore' \
            --exclude='test-*.php' --exclude='CLAUDE.md' --exclude='.distignore' \
            --exclude='*.sh' --exclude='.DS_Store' --exclude='.editorconfig' \
            --exclude='docs' --exclude='temp' --exclude='*.log' \
            --exclude='.gitignore' --exclude='.gitattributes' \
            . dist/zbooks-for-woocommerce/
          # Remove any markdown files except readme.txt (which we have instead of readme.md)
          find dist/zbooks-for-woocommerce -name "*.md" -type f -delete
          # Create zip with proper folder structure
          cd dist && zip -r zbooks-for-woocommerce-${{ steps.version.outputs.VERSION }}.zip zbooks-for-woocommerce
          rm -rf zbooks-for-woocommerce

      - name: Generate changelog
        id: changelog
        run: |
          # Extract changelog for this version from readme.txt
          VERSION="${{ steps.version.outputs.VERSION }}"
          CHANGELOG=$(sed -n "/^= $VERSION/,/^= [0-9]/p" readme.txt | head -n -1 | tail -n +2)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See readme.txt for changelog."
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ZBooks for WooCommerce v${{ steps.version.outputs.VERSION }}
          body: |
            ## ZBooks for WooCommerce v${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ### Installation

            1. Download `zbooks-for-woocommerce-${{ steps.version.outputs.VERSION }}.zip`
            2. Upload to WordPress via Plugins > Add New > Upload Plugin
            3. Activate and configure at WooCommerce > Settings > ZBooks

            ### Requirements

            - WordPress 6.9+
            - WooCommerce 10.4+
            - PHP 8.2+
          files: |
            dist/zbooks-for-woocommerce-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
